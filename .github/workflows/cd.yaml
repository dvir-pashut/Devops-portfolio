name: CD

on:
  workflow_run:
    workflows: [CI]
    types:
      - completed

jobs:
  CD:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: clone the gitops repo
      if: ${{ github.ref == 'refs/heads/main'}}
      uses: actions/checkout@v3
      with:
        repository: dvir-pashut/port-charts
        token: ${{ secrets.KEYSSSSS }}
        ref: main

    - name: do some gitops
      if: ${{ github.ref == 'refs/heads/main'}}
      run: |
        tag="${{ steps.tag.outputs.new_tag }}"
        sed -i "s/tag:.*/tag: $tag/" dvireview/values.yaml
        git config --global user.email "github@git.com"
        git config --global user.name "github actions"
        git add values.yaml
        git commit -m "update the image tag to $tag"
        git push origin main

    - name: Slack Notification
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_CHANNEL: general
        SLACK_COLOR: ${{ job.status }} # or a specific color like 'good' or '#ff00ff'
        SLACK_ICON: https://github.com/rtCamp.png?size=48
        SLACK_MESSAGE: 'Post Content the job on brunch ${{ github.ref }}  was ${{ job.status }} :rocket: '
        SLACK_TITLE: CI Report
        SLACK_USERNAME: GithubActions
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}